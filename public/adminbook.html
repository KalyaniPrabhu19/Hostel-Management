<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Room Booking</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-[#F7F8FA] min-h-screen flex flex-col items-center py-10">
  <h1 class="text-4xl font-bold mb-8 text-blue-800 tracking-wide">
    üè® Admin Room Booking Panel
  </h1>

  <!-- Student selection -->
  <div class="flex flex-col sm:flex-row gap-4 mb-6 items-center">
    <input
      type="text"
      id="studentIdInput"
      placeholder="Enter Student ID (e.g., STU123)"
      class="border border-gray-300 rounded-lg px-4 py-2 w-72 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"
    />
    <button
      id="loadRooms"
      class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2.5 rounded-lg shadow-md transition-all"
    >
      Show Available Hostels & Rooms
    </button>
  </div>

  <!-- Room Cards -->
  <div
    id="roomsContainer"
    class="mt-10 w-full max-w-6xl grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 px-4"
  ></div>

  <script>
    document.getElementById("loadRooms").addEventListener("click", () => {
      const studentId = document.getElementById("studentIdInput").value.trim();

      if (!studentId) {
        alert("‚ö†Ô∏è Please enter a Student ID before proceeding.");
        return;
      }

      const userId = localStorage.getItem("user_id");
      fetch(`http://localhost:5000/api/rooms?user_id=${userId}`)
        .then((res) => {
          if (!res.ok) throw new Error("Network error");
          return res.json();
        })
        .then((data) => {
          const container = document.getElementById("roomsContainer");
          container.innerHTML = "";

          if (!data || data.length === 0) {
            container.innerHTML = `<p class="text-gray-600 text-center col-span-full">No rooms found.</p>`;
            return;
          }

          // Group rooms by hostel name
          const hostels = {};
          data.forEach((room) => {
            if (!hostels[room.hostel_name]) hostels[room.hostel_name] = [];
            hostels[room.hostel_name].push(room);
          });

          // Create hostel cards
          Object.keys(hostels).forEach((hostelName) => {
            const card = document.createElement("div");
            card.className =
              "bg-white rounded-xl shadow-lg border border-gray-200 p-5 hover:shadow-2xl transition-all duration-200";

            let tableRows = hostels[hostelName]
              .map((room) => {
                const full = room.status === "full";
                const statusColor = full ? "text-red-600" : "text-green-600";

                return `
                  <tr class="border-t border-gray-100 hover:bg-gray-50">
                    <td class="py-2 px-2 text-gray-800">${room.room_id}</td>
                    <td class="py-2 px-2 text-gray-600">${room.room_type}</td>
                    <td class="py-2 px-2 font-semibold ${statusColor}">
                      ${room.status}
                    </td>
                    <td class="py-2 px-2 text-gray-700">‚Çπ${room.rent}</td>
                    <td class="py-2 px-2">
                      ${
                        full
                          ? `<button class="bg-gray-400 text-white px-3 py-1 rounded-md text-sm cursor-not-allowed">Full</button>`
                          : `<button class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-md text-sm"
                              onclick="bookRoom(${room.room_id}, '${studentId}')">Book</button>`
                      }
                    </td>
                  </tr>
                `;
              })
              .join("");

            card.innerHTML = `
              <h2 class="text-2xl font-semibold text-blue-700 mb-4 border-b pb-2">${hostelName}</h2>
              <div class="overflow-x-auto">
                <table class="w-full text-sm text-left border-collapse">
                  <thead class="bg-blue-100">
                    <tr>
                      <th class="py-2 px-2 text-gray-700">Room No</th>
                      <th class="py-2 px-2 text-gray-700">Type</th>
                      <th class="py-2 px-2 text-gray-700">Status</th>
                      <th class="py-2 px-2 text-gray-700">Rent</th>
                      <th class="py-2 px-2 text-gray-700">Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${tableRows}
                  </tbody>
                </table>
              </div>
            `;
            container.appendChild(card);
          });
        })
        .catch((err) => {
          console.error("Error loading rooms:", err);
          alert("Error loading rooms. Please check your server connection.");
        });
    });

    // Admin Booking Logic
    function bookRoom(roomId, studentId) {
      if (!confirm(`Are you sure you want to book Room ${roomId} for ${studentId}?`)) return;

      fetch("http://localhost:5000/admin/book-room", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          room_id: roomId,
          student_id: studentId,
        }),
      })
        .then(async (res) => {
          const text = await res.text();
          if (!res.ok) throw new Error(`Server Error (${res.status}): ${text}`);
          return JSON.parse(text);
        })
        .then((data) => {
          alert(data.message || "‚úÖ Room booked successfully!");
          document.getElementById("loadRooms").click(); // refresh list
        })
        .catch((err) => {
          console.error("üî• Booking error:", err);
          alert(err.message || "Error booking room. Check console for details.");
        });
    }
  </script>
</body>
</html>
